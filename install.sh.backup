#!/bin/bash

# Stop bij fouten
set -e

# Kleuren voor output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

echo -e "${BLUE}=== Start installatie TmuxAI & Devstral Setup ===${NC}"

# --- STAP 1: Tmux Controleren/Installeren ---
if ! command -v tmux &> /dev/null; then
    echo "Tmux niet gevonden. Bezig met installeren..."
    if [[ "$OSTYPE" == "linux-gnu"* ]]; then
        if command -v apt-get &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y tmux
        elif command -v yum &> /dev/null; then
            sudo yum install -y tmux
        else
            echo "Geen ondersteunde package manager gevonden. Installeer tmux handmatig."
            exit 1
        fi
    elif [[ "$OSTYPE" == "darwin"* ]]; then
        if command -v brew &> /dev/null; then
            brew install tmux
        else
            echo "Homebrew niet gevonden. Installeer tmux handmatig."
            exit 1
        fi
    fi
else
    echo -e "${GREEN}âœ“ Tmux is al aanwezig.${NC}"
fi

# --- STAP 2: TmuxAI Controleren/Installeren ---
# We gebruiken de officiÃ«le 'Quick Install' one-liner van tmuxai.dev
if ! command -v tmuxai &> /dev/null; then
    echo "TmuxAI wordt geÃ¯nstalleerd..."
    
    # Dit script detecteert automatisch je OS en installeert de juiste versie
    curl -fsSL https://get.tmuxai.dev | bash

    echo -e "${GREEN}âœ“ TmuxAI installatie voltooid.${NC}"
else
    echo -e "${GREEN}âœ“ TmuxAI is al aanwezig.${NC}"
fi

# --- STAP 3: Configuratie (Met Back-up Functie) ---
CONFIG_DIR="$HOME/.config/tmuxai"
CONFIG_FILE="$CONFIG_DIR/config.yaml"

# Maak map indien nodig
mkdir -p "$CONFIG_DIR"

# BACKUP LOGICA: Veilig voor bestaande installaties
if [ -f "$CONFIG_FILE" ]; then
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    BACKUP_FILE="$CONFIG_FILE.backup_$TIMESTAMP"
    echo -e "${YELLOW}! Bestaande configuratie gevonden.${NC}"
    echo "  -> Back-up maken naar: $BACKUP_FILE"
    mv "$CONFIG_FILE" "$BACKUP_FILE"
fi

echo ""
echo -e "${BLUE}Configuratie instellen voor Mistral Devstral.${NC}"

# API Key input loop - blijft vragen tot geldige key of Ctrl-C
API_KEY=""
VALID_KEY=0

while [ $VALID_KEY -eq 0 ]; do
    echo -n "Voer je Mistral API Key in (of druk Ctrl-C om te annuleren): "
    read -r API_KEY

    if [ -z "$API_KEY" ]; then
        echo -e "${RED}âœ— Geen key ingevoerd. Probeer opnieuw.${NC}"
        continue
    fi

    # Valideer de API key
    echo -e "${YELLOW}Bezig met valideren van API key...${NC}"
    RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" \
        -H "Authorization: Bearer $API_KEY" \
        -H "Content-Type: application/json" \
        "https://api.mistral.ai/v1/models")

    if [ "$RESPONSE" -eq 200 ]; then
        echo -e "${GREEN}âœ“ API key is geldig en werkt.${NC}"
        VALID_KEY=1
    else
        echo -e "${RED}âœ— API key is ongeldig of werkt niet. HTTP Status: $RESPONSE${NC}"
        echo -e "${YELLOW}Druk Ctrl-C om het script te stoppen, of probeer een andere key.${NC}"
        # Reset API_KEY so we ask again
        API_KEY=""
    fi
done

# Schrijf de nieuwe config
cat > "$CONFIG_FILE" <<EOL
models:
  default:
    provider: openrouter
    base_url: "https://api.mistral.ai/v1"
    api_key: "$API_KEY"
    model: "codestral-latest"
EOL

echo -e "${GREEN}âœ“ Nieuwe configuratie geschreven naar $CONFIG_FILE${NC}"

# --- STAP 4: Uitleg ---
echo ""
echo "============================================="
echo -e "${GREEN}Installatie Voltooid!${NC}"
echo "============================================="
echo "Je bent klaar om te beginnen."
echo ""
echo -e "ðŸš€  ${BLUE}Starten:${NC} Typ simpelweg ${GREEN}tmuxai${NC}"
echo ""
echo "Dit start automatisch een Tmux-sessie met de AI al geladen."
echo "Je hoeft tmux niet eerst apart te starten."
echo ""
echo -e "${BLUE}Hoe TmuxAI te gebruiken:${NC}"
echo -e "1. Start een nieuwe sessie met: ${GREEN}tmuxai${NC}"
echo "2. Typ je vraag of opdracht in de terminal."
echo "3. TmuxAI zal je input zien en je helpen."
echo ""
echo -e "${BLUE}Voorbeelden:${NC}"
echo "- 'Hoe maak ik een nieuw Python-bestand?'"
echo "- 'Leg uit hoe deze code werkt.'"
echo "- 'Help me met het debuggen van dit script.'"
echo "- 'Hoe gebruik ik git om mijn wijzigingen te committen?'"
echo "- 'Schrijf een script dat alle .txt bestanden in een map telt.'"
echo ""
echo -e "${BLUE}Tips:${NC}"
echo "- TmuxAI ziet alles in je huidige tmux-venster."
echo "- Je kunt meerdere panes openen en TmuxAI ziet ze allemaal."
echo "- Gebruik duidelijke en specifieke vragen voor de beste resultaten."
echo "- TmuxAI kan je helpen met code, uitleg, debugging en meer."
echo ""
echo "Provider: Mistral"
echo "Model: devstral-latest"
